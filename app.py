# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12YHG62azQ9FYB_0bvBHdYl2A5gHvLqMO
"""

# 1. Basic App Skeleton

import streamlit as st
import pandas as pd
import numpy as np
import pickle

# 2. Loading the Artifacts

with open("attrition_model.pkl", "rb") as f:
    model = pickle.load(f)

with open("scaler.pkl", "rb") as f:
    scaler = pickle.load(f)

with open("feature_columns.pkl", "rb") as f:
    feature_columns = pickle.load(f)

# 3. Getting model coefficients and Renaming Feature Names for Explanation
coefficients = model.coef_[0]

# Renaming feature names for explanations
feature_name_map = {
    "OverTime_Yes": "Working Overtime",
    "YearsAtCompany": "Years at Company",
    "JobSatisfaction": "Job Satisfaction",
    "MonthlyIncome": "Monthly Income",
    "YearsSinceLastPromotion": "Years Since Last Promotion",
    "TotalWorkingYears": "Total Work Experience",
    "DistanceFromHome": "Distance From Home",
    "EnvironmentSatisfaction": "Work Environment Satisfaction",
    "JobInvolvement": "Job Involvement",
    "Age": "Age"
}


# 4. App Title & Description

st.set_page_config(page_title="Employee Attrition Predictor", layout="centered")

st.title("Employee Attrition Prediction App")

st.write(
    "This application predicts the **probability of an employee leaving the company** "
    "based on job characteristics, satisfaction levels, and work-related factors. "
    "The model can help HR teams identify high-risk employees early and take "
    "proactive retention measures."
)

st.divider()

# 5. User Input Form

st.subheader("Employee Details")

def user_input_features():
    Age = st.slider("Age", 18, 60, 30)
    MonthlyIncome = st.slider("Monthly Income", 1000, 20000, 5000)
    DistanceFromHome = st.slider("Distance From Home", 1, 30, 10)
    TotalWorkingYears = st.slider("Total Working Years", 0, 40, 10)
    YearsAtCompany = st.slider("Years At Company", 0, 40, 5)
    YearsSinceLastPromotion = st.slider("Years Since Last Promotion", 0, 15, 2)
    JobSatisfaction = st.selectbox("Job Satisfaction", [1, 2, 3, 4])
    EnvironmentSatisfaction = st.selectbox("Environment Satisfaction", [1, 2, 3, 4])
    JobInvolvement = st.selectbox("Job Involvement", [1, 2, 3, 4])
    OverTime = st.selectbox("OverTime", ["Yes", "No"])

    data = {
        "Age": Age,
        "MonthlyIncome": MonthlyIncome,
        "DistanceFromHome": DistanceFromHome,
        "TotalWorkingYears": TotalWorkingYears,
        "YearsAtCompany": YearsAtCompany,
        "YearsSinceLastPromotion": YearsSinceLastPromotion,
        "JobSatisfaction": JobSatisfaction,
        "EnvironmentSatisfaction": EnvironmentSatisfaction,
        "JobInvolvement": JobInvolvement,
        "OverTime_Yes": 1 if OverTime == "Yes" else 0
    }

    return pd.DataFrame([data])

# 6. Aligning Input with Training Features

input_df = user_input_features()

# Add missing columns
for col in feature_columns:
    if col not in input_df.columns:
        input_df[col] = 0

# Reorder columns
input_df = input_df[feature_columns]

# Scale input
input_scaled = scaler.transform(input_df)

# Calculate feature contributions
contributions = input_scaled[0] * coefficients

contrib_df = pd.DataFrame({
    "Feature": feature_columns,
    "Contribution": contributions
})

# Sort by absolute contribution
contrib_df["AbsContribution"] = contrib_df["Contribution"].abs()
contrib_df = contrib_df.sort_values(by="AbsContribution", ascending=False)

# 7. Prediction & Output

st.divider()

st.subheader("Prediction Result")

if st.button("Predict Attrition Risk"):
    prob = model.predict_proba(input_scaled)[0][1]

    st.subheader("Prediction Result")

    if prob > 0.6:
        st.error(f"High Attrition Risk (Probability: {prob:.2f})")
    elif prob > 0.3:
        st.warning(f"Medium Attrition Risk (Probability: {prob:.2f})")
    else:
        st.success(f"Low Attrition Risk (Probability: {prob:.2f})")

        st.divider()
    st.subheader("Why this prediction?")

    top_reasons = contrib_df.head(5)

    for _, row in top_reasons.iterrows():
        direction = "increases" if row["Contribution"] > 0 else "reduces"
        feature_name = feature_name_map.get(row["Feature"], row["Feature"])

        st.write(
            f"â€¢ **{feature_name}** {direction} attrition risk"
        )

    st.caption(
        "Prediction is based on historical employee data and should be used as a "
        "decision-support tool, not as the sole basis for HR decisions."
    )
